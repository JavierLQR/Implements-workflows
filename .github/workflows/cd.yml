name: CD - Backend Deploy

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      # 1. Obtener cÃ³digo
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      # 2. Setup PNPM
      - name: ğŸ“¦ Setup PNPM v10.19.0
        uses: pnpm/action-setup@v4
        with:
          version: 10.19.0
          run_install: false

      # 3. Setup Node.js con cache de PNPM
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm

      # 4. Instalar dependencias (si build es necesario para despliegue)
      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      # 5. Build del backend (si tu deploy lo necesita)
      - name: ğŸ—ï¸ Build
        run: pnpm build

        # 6. Empaquetar build y copiar los archivos necesarios para deploy
      - name: ğŸ“¦ Prepare artifact
        run: |
          mkdir deploy
          cp -r dist deploy/dist
          cp package.json deploy/package.json
          cp pnpm-lock.yaml deploy/pnpm-lock.yaml

      # Aqui irÃ­an los pasos para subir al servidor y ejecutar comandos remotos
      #  (estos pasos dependen de tu infraestructura y no estÃ¡n implementados)
      #  Ejemplo usando SCP y SSH con llaves almacenadas en Secrets de GitHub

      # 6ï¸âƒ£ Subir al servidor (VPS, Droplet, EC2)
      # - name: ğŸš€ Upload files to server
      #   uses: appleboy/scp-action@v0.1.7
      #   with:
      #     host: ${{ secrets.DEPLOY_HOST }}
      #     username: ${{ secrets.DEPLOY_USER }}
      #     key: ${{ secrets.DEPLOY_SSH_KEY }}
      #     source: "deploy/*"
      #     target: "/var/www/app"

      # # 7ï¸âƒ£ Ejecutar comandos en servidor
      # - name: ğŸ› ï¸ Run deploy tasks on server
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.DEPLOY_HOST }}
      #     username: ${{ secrets.DEPLOY_USER }}
      #     key: ${{ secrets.DEPLOY_SSH_KEY }}
      #     script: |
      #       cd /var/www/app

      #       echo "ğŸ“¥ Updating dependencies"
      #       pnpm install --prod --frozen-lockfile

      #       echo "ğŸ”„ Restarting PM2"
      #       pm2 reload ecosystem.config.js --update-env

      #       echo "âœ… Deploy complete"
